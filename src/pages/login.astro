---
import '../styles.css';
---
<html>
  <head><meta charset="utf-8"><title>Login</title></head>
  <body>
    <div class="container">
      <div class="card">
        <h2>Login (AES encrypted)</h2>
        <label>Email</label><input id="email" type="email" />
        <label>Password</label><input id="password" type="password" />
        <button class="btn" id="btn">Login</button>
        <p id="msg" class="small"></p>
      </div>
    </div>

    <script type="module">
      // helper: convert base64 to Uint8Array
      function b64ToUint8(b64){return Uint8Array.from(atob(b64), c=>c.charCodeAt(0));}
      async function importKey(rawBase64){
        const raw = b64ToUint8(rawBase64);
        return crypto.subtle.importKey('raw', raw, 'AES-GCM', false, ['encrypt','decrypt']);
      }

      async function encrypt(key, text){
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const enc = new TextEncoder().encode(text);
        const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc);
        return { iv: btoa(String.fromCharCode(...iv)), ct: btoa(String.fromCharCode(...new Uint8Array(ct))) };
      }

      document.getElementById('btn').addEventListener('click', async ()=>{
        const email = document.getElementById('email').value;
        const pw = document.getElementById('password').value;
        if(!email||!pw){document.getElementById('msg').textContent='Enter email & password'; return;}
        // Ask server for key id / or use env-exposed base64 key retrieval route (we won't expose secret directly)
        // For demo, we'll fetch a lightweight public endpoint that returns an **encoded** AES key (Pages secret is used server-side).
        const keyResp = await fetch('/api/get-client-key'); // returns { key_b64 }
        const { key_b64 } = await keyResp.json();
        const aesKey = await importKey(key_b64);
        const { iv, ct } = await encrypt(aesKey, pw);
        const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, ciphertext: ct, iv })});
        const j = await res.json();
        if(res.ok && j.ok) { window.location = '/dashboard'; }
        else document.getElementById('msg').textContent = j.error || 'Login failed';
      });
    </script>
  </body>
</html>
